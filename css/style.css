/* ===========================================
   Variables & Reset
   =========================================== */
:root {
    --primary: #3b82f6;
    --secondary: #8b5cf6;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    
    --bg-primary: #ffffff;
    --bg-secondary: #f8fafc;
    --bg-tertiary: #f1f5f9;
    
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #94a3b8;
    
    --border: #e2e8f0;
    
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    
    --radius: 0.5rem;
    --radius-lg: 0.75rem;
    
    --space-xs: 0.5rem;
    --space-sm: 1rem;
    --space-md: 1.5rem;
    --space-lg: 2rem;
    --space-xl: 3rem;
}

[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #64748b;
    --border: #334155;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-secondary);
    color: var(--text-primary);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-md);
}

/* ===========================================
   Navigation
   =========================================== */
.navbar {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    padding: var(--space-sm) 0;
    position: sticky;
    top: 0;
    z-index: 100;
}

.navbar .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.nav-brand {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
}

.badge {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
}

.btn-icon {
    width: 2.5rem;
    height: 2.5rem;
    border: none;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: var(--bg-tertiary);
    transform: translateY(-2px);
}

/* ===========================================
   Hero
   =========================================== */
.hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: var(--space-xl) 0;
    text-align: center;
    color: white;
}

.hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 0.5rem 1.5rem;
    border-radius: 999px;
    font-size: 0.875rem;
    margin-bottom: var(--space-md);
}

.hero-title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    margin-bottom: var(--space-md);
    line-height: 1.2;
}

.gradient-text {
    display: block;
    background: linear-gradient(to right, #60a5fa, #a78bfa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-subtitle {
    font-size: 1.25rem;
    opacity: 0.9;
    max-width: 600px;
    margin: 0 auto var(--space-lg);
}

/* ===========================================
   Buttons
   =========================================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: #059669;
}

.btn-secondary {
    background: var(--text-secondary);
    color: white;
}

.btn-record {
    background: var(--danger);
    color: white;
}

.btn-record:hover {
    background: #dc2626;
}

.btn-stop {
    background: var(--text-secondary);
    color: white;
}

.btn-large {
    padding: 1rem 2rem;
    font-size: 1rem;
}

.btn-block {
    width: 100%;
}

.btn-remove {
    width: 2rem;
    height: 2rem;
    border: none;
    background: var(--bg-secondary);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-remove:hover {
    background: var(--danger);
    color: white;
}

/* ===========================================
   Main Content
   =========================================== */
main {
    padding: var(--space-xl) 0;
}

.card {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow);
}

.card h2 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.5rem;
    margin-bottom: var(--space-lg);
}

.card h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.125rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}

/* ===========================================
   Recording Section
   =========================================== */
.recorder-box {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.1));
    border: 2px dashed rgba(239, 68, 68, 0.3);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    text-align: center;
}

.recorder-visual {
    margin-bottom: var(--space-lg);
}

.mic-icon {
    width: 5rem;
    height: 5rem;
    background: linear-gradient(135deg, var(--danger), #dc2626);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-md);
    color: white;
    font-size: 2rem;
}

.recording-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--danger);
}

.pulse-dot {
    width: 12px;
    height: 12px;
    background: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

.recording-time {
    font-variant-numeric: tabular-nums;
}

/* ===========================================
   Divider
   =========================================== */
.divider {
    display: flex;
    align-items: center;
    text-align: center;
    margin: var(--space-xl) 0;
}

.divider::before,
.divider::after {
    content: '';
    flex: 1;
    border-bottom: 2px solid var(--border);
}

.divider span {
    padding: 0 var(--space-md);
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
}

/* ===========================================
   Upload Zone
   =========================================== */
.upload-zone {
    border: 3px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.upload-zone:hover {
    border-color: var(--primary);
    background: rgba(59, 130, 246, 0.05);
}

.upload-icon {
    font-size: 4rem;
    color: var(--primary);
    margin-bottom: var(--space-md);
}

.upload-zone h4 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
}

.upload-zone p {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

/* ===========================================
   File Preview
   =========================================== */
.file-preview {
    margin-top: var(--space-lg);
}

.file-card {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
}

.file-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.file-icon {
    width: 3rem;
    height: 3rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.file-info {
    flex: 1;
}

.file-info h4 {
    margin-bottom: 0.25rem;
}

.file-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.dot {
    opacity: 0.5;
}

.audio-player {
    margin-bottom: var(--space-md);
}

.audio-player audio {
    width: 100%;
}

/* ===========================================
   Results
   =========================================== */
.results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
}

.transcript-box {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-md);
}

.transcript-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
}

.transcript-text {
    background: white;
    padding: var(--space-lg);
    border-radius: var(--radius);
    min-height: 200px;
    line-height: 1.8;
    white-space: pre-wrap;
    border-left: 4px solid var(--success);
}

.info-box {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid var(--primary);
    border-radius: var(--radius);
    color: var(--text-secondary);
}

/* ===========================================
   Footer
   =========================================== */
.footer {
    background: var(--text-primary);
    color: white;
    padding: var(--space-xl) 0 var(--space-lg);
    margin-top: var(--space-xl);
}

.footer-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.footer-brand p {
    margin-top: 0.5rem;
    opacity: 0.8;
}

.footer-links {
    display: flex;
    gap: var(--space-lg);
}

.footer-links a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color 0.2s;
}

.footer-links a:hover {
    color: white;
}

.footer-bottom {
    text-align: center;
    padding-top: var(--space-md);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 0.875rem;
    opacity: 0.8;
}

.footer-bottom p {
    margin: 0.25rem 0;
}

/* ===========================================
   Toast
   =========================================== */
.toast-container {
    position: fixed;
    top: var(--space-lg);
    right: var(--space-lg);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.toast {
    background: var(--bg-primary);
    padding: var(--space-md);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 300px;
    max-width: 400px;
    animation: slideIn 0.3s ease;
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.warning { border-left: 4px solid var(--warning); }
.toast.info { border-left: 4px solid var(--primary); }

.toast i {
    font-size: 1.25rem;
}

.toast.success i { color: var(--success); }
.toast.error i { color: var(--danger); }
.toast.warning i { color: var(--warning); }
.toast.info i { color: var(--primary); }

/* Alert Box */
.alert {
    padding: var(--space-md);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-lg);
    display: flex;
    gap: var(--space-md);
    align-items: flex-start;
}

.alert-info {
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid var(--primary);
}

.alert i {
    font-size: 1.5rem;
    color: var(--primary);
}

.alert ol {
    line-height: 1.8;
}

.alert small {
    color: var(--text-secondary);
}



/**
 * Main Application Logic
 * ‡πÉ‡∏ä‡πâ Whisper.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
 */

// ===========================================
// Global Variables
// ===========================================
let currentFile = null;
let audioRecorder = null;
let recordingTimer = null;

// ===========================================
// Initialize
// ===========================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ App initializing...');
    
    initializeRecorder();
    initializeUpload();
    initializeFilePreview();
    initializeTranscription();
    
    console.log('‚úÖ App ready');
});

// ===========================================
// Recording Functions
// ===========================================
function initializeRecorder() {
    audioRecorder = new AudioRecorder();
    
    const startBtn = document.getElementById('startRecordBtn');
    const stopBtn = document.getElementById('stopRecordBtn');
    const statusEl = document.getElementById('recordingStatus');
    
    startBtn?.addEventListener('click', async () => {
        try {
            await audioRecorder.start();
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-flex';
            statusEl.style.display = 'flex';
            
            updateRecordingTime();
            recordingTimer = setInterval(updateRecordingTime, 1000);
            
            showToast('üé§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...', 'success');
            
        } catch (error) {
            console.error('Recording error:', error);
            
            if (error.name === 'NotAllowedError') {
                showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô', 'error');
            } else if (error.name === 'NotFoundError') {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô', 'error');
            } else {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }
    });
    
    stopBtn?.addEventListener('click', () => {
        audioRecorder.stop();
        
        startBtn.style.display = 'inline-flex';
        stopBtn.style.display = 'none';
        statusEl.style.display = 'none';
        
        clearInterval(recordingTimer);
        document.querySelector('.recording-time').textContent = '00:00';
    });
    
    document.addEventListener('recordingComplete', (e) => {
        handleFileSelection(e.detail.file);
        showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
    });
}

function updateRecordingTime() {
    const elapsed = audioRecorder.getElapsedTime();
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    const timeText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    
    const timeEl = document.querySelector('.recording-time');
    if (timeEl) timeEl.textContent = timeText;
}

// ===========================================
// Upload Functions
// ===========================================
function initializeUpload() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('audioFile');
    
    if (!uploadZone || !fileInput) return;
    
    uploadZone.addEventListener('click', () => {
        fileInput.click();
    });
    
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--primary)';
        uploadZone.style.background = 'rgba(59, 130, 246, 0.05)';
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.style.borderColor = 'var(--border)';
        uploadZone.style.background = '';
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--border)';
        uploadZone.style.background = '';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files);
        }
    });
}

function handleFileSelection(file) {
    const validTypes = ['audio/wav', 'audio/mpeg', 'audio/mp3', 'audio/x-m4a', 'audio/flac', 'audio/webm', 'audio/ogg'];
    const validExt = /\.(wav|mp3|m4a|flac|webm|ogg)$/i;
    
    if (!validTypes.includes(file.type) && !file.name.match(validExt)) {
        showToast('‚ùå ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }
    
    if (file.size > 100 * 1024 * 1024) {
        showToast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100MB)', 'error');
        return;
    }
    
    currentFile = file;
    
    document.getElementById('recordingSection').style.display = 'none';
    document.querySelector('.divider').style.display = 'none';
    document.querySelector('.upload-section').style.display = 'none';
    
    const preview = document.getElementById('filePreview');
    preview.style.display = 'block';
    
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    
    const audioPlayer = document.getElementById('audioPlayer');
    const audioUrl = URL.createObjectURL(file);
    audioPlayer.src = audioUrl;
    
    audioPlayer.addEventListener('loadedmetadata', () => {
        document.getElementById('fileDuration').textContent = formatDuration(audioPlayer.duration);
    });
    
    showToast('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
}

// ===========================================
// File Preview
// ===========================================
function initializeFilePreview() {
    const removeBtn = document.getElementById('removeFile');
    
    removeBtn?.addEventListener('click', () => {
        document.getElementById('recordingSection').style.display = 'block';
        document.querySelector('.divider').style.display = 'flex';
        document.querySelector('.upload-section').style.display = 'block';
        document.getElementById('filePreview').style.display = 'none';
        
        currentFile = null;
        document.getElementById('audioFile').value = '';
        document.getElementById('audioPlayer').src = '';
        
        showToast('üóëÔ∏è ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß', 'info');
    });
}

// ===========================================
// Transcription
// ===========================================
function initializeTranscription() {
    const transcribeBtn = document.getElementById('transcribeBtn');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const newBtn = document.getElementById('newBtn');
    
    // Transcribe
    transcribeBtn?.addEventListener('click', async () => {
        if (!currentFile) {
            showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'error');
            return;
        }
        
        if (!window.isWhisperReady || !window.isWhisperReady()) {
            showToast('‚ö†Ô∏è AI Model ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', 'warning');
            return;
        }
        
        await transcribeWithWhisper();
    });
    
    // Copy
    copyBtn?.addEventListener('click', () => {
        const text = document.getElementById('transcriptText').textContent;
        
        if (!text || text === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...') {
            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 'error');
            return;
        }
        
        navigator.clipboard.writeText(text).then(() => {
            showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
        });
    });
    
    // Download
    downloadBtn?.addEventListener('click', () => {
        const text = document.getElementById('transcriptText').textContent;
        
        if (!text || text === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...') {
            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î', 'error');
            return;
        }
        
        downloadTranscript(text, currentFile.name);
    });
    
    // New
    newBtn?.addEventListener('click', () => {
        resetApp();
    });
}

// ===========================================
// Transcribe with Whisper
// ===========================================
async function transcribeWithWhisper() {
    try {
        // Show progress section
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        
        updateProgress(10, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...');
        
        // Scroll to progress
        setTimeout(() => {
            document.getElementById('progressSection').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
        
        showToast('üéß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢ AI...', 'info');
        
        // Transcribe
        const result = await window.transcribeAudioFile(currentFile, (progress) => {
            console.log('Progress:', progress);
            
            if (progress.status === 'progress') {
                const percent = Math.round(progress.progress * 100);
                updateProgress(percent, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...');
            }
        });
        
        updateProgress(100, '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
        
        // Display result
        setTimeout(() => {
            displayTranscriptionResult(result);
        }, 500);
        
    } catch (error) {
        console.error('Transcription error:', error);
        
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('transcriptText').textContent = 
            `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á\n\n` +
            `‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${error.message}\n\n` +
            `‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:\n` +
            `1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢\n` +
            `2. ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏Å‡πà‡∏≠‡∏ô\n` +
            `3. Refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`;
        
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    }
}

// ===========================================
// Display Result
// ===========================================
function displayTranscriptionResult(result) {
    // Hide progress
    document.getElementById('progressSection').style.display = 'none';
    
    // Show results
    document.getElementById('resultsSection').style.display = 'block';
    
    // Extract text
    let transcriptText = '';
    
    if (typeof result === 'string') {
        transcriptText = result;
    } else if (result.text) {
        transcriptText = result.text;
    } else if (result.chunks) {
        transcriptText = result.chunks.map(chunk => chunk.text).join(' ');
    }
    
    // Display
    if (transcriptText && transcriptText.trim()) {
        document.getElementById('transcriptText').textContent = transcriptText.trim();
        showToast('‚úÖ ‡∏ñ‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
    } else {
        document.getElementById('transcriptText').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà';
        showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'warning');
    }
    
    // Scroll to results
    setTimeout(() => {
        document.getElementById('resultsSection').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }, 100);
}

// ===========================================
// Progress Update
// ===========================================
function updateProgress(percent, message) {
    const fillEl = document.getElementById('progressFill');
    const textEl = document.getElementById('progressText');
    const percentEl = document.getElementById('progressPercent');
    
    if (fillEl) fillEl.style.width = `${percent}%`;
    if (textEl) textEl.textContent = message;
    if (percentEl) percentEl.textContent = `${percent}%`;
}

// ===========================================
// Download Transcript
// ===========================================
function downloadTranscript(text, originalFilename) {
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    const filename = originalFilename.replace(/\.[^/.]+$/, '') + '_transcript.txt';
    
    a.href = url;
    a.download = filename;
    a.click();
    
    URL.revokeObjectURL(url);
    
    showToast('üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
}

// ===========================================
// Reset App
// ===========================================
function resetApp() {
    document.getElementById('progressSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    
    document.getElementById('recordingSection').style.display = 'block';
    document.querySelector('.divider').style.display = 'flex';
    document.querySelector('.upload-section').style.display = 'block';
    document.getElementById('filePreview').style.display = 'none';
    
    currentFile = null;
    document.getElementById('audioFile').value = '';
    
    const audioPlayer = document.getElementById('audioPlayer');
    audioPlayer.pause();
    audioPlayer.src = '';
    
    document.getElementById('transcriptText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    showToast('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà', 'info');
}

console.log('‚úÖ App loaded with Whisper AI');
